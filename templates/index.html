<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <div style="max-width: 700px; margin: auto 20px 10px">
      <label for="model-select">Choose model:</label>
      <select id="model-select">
        <option value="openai">OpenAI GPT-3.5-turbo</option>
        <option value="ollama">Ollama Mistral</option>
      </select>
      <span id="current-model" style="margin-left: 20px; font-weight: bold"
        >Current model: OpenAI GPT-3.5-turbo</span
      >
    </div>
    <title>Nova Przestrzeń chatbot</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: #f7f7f7;
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 20px;
      }

      #chat {
        max-width: 700px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 6px;
        height: 70vh;
        overflow-y: auto;
        box-shadow: 0 0 10px #ccc;
      }

      .message {
        margin-bottom: 15px;
        white-space: pre-wrap; /* preserve line breaks and spaces */
      }

      .user {
        color: #015ec2; /* blue */
      }

      .bot {
        color: #001f4d; /* navy */
      }

      #input-area {
        max-width: 700px;
        margin: auto;
        display: flex;
        margin-top: 10px;
      }

      #message {
        flex: 1;
        padding: 10px;
        font-size: 1rem;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      #send {
        padding: 10px 15px;
        margin-left: 10px;
        font-size: 1rem;
        background: #0044cc;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      #send:disabled {
        background: #999;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <h1>Nova Przestrzeń</h1>
    <div id="chat"></div>

    <div id="input-area">
      <input
        type="text"
        id="message"
        placeholder="Type your message here..."
        autocomplete="off"
      />
      <button id="send" disabled>Send</button>
    </div>

    <script>
      const chatEl = document.getElementById("chat");
      const inputEl = document.getElementById("message");
      const sendBtn = document.getElementById("send");
      const modelSelect = document.getElementById("model-select");
      const currentModelLabel = document.getElementById("current-model");

      let sessionId = null;
      let isWaitingForResponse = false;
      let selectedModel = modelSelect.value; // default model
      let currentBotMessage = null; // Track the current streaming message

      // Update label when model changes
      modelSelect.addEventListener("change", () => {
        selectedModel = modelSelect.value;
        const labelText =
          selectedModel === "openai"
            ? "Current model: OpenAI GPT-3.5-turbo"
            : "Current model: Ollama Mistral";
        currentModelLabel.textContent = labelText;

        // Optional: reset chat when model changes
        chatEl.innerHTML = "";
        currentBotMessage = null;
        startSession();
      });

      function addMessage(text, sender) {
        const msgDiv = document.createElement("div");
        msgDiv.className = "message " + sender;

        if (sender === "bot") {
          msgDiv.innerHTML = formatBotText(text);
        } else {
          msgDiv.textContent = text;
        }

        chatEl.appendChild(msgDiv);
        chatEl.scrollTop = chatEl.scrollHeight;
        return msgDiv;
      }

      function appendToMessage(msgDiv, text) {
        if (msgDiv.classList.contains("bot")) {
          msgDiv.innerHTML += formatBotText(text);
        } else {
          msgDiv.textContent += text;
        }
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      function formatBotText(text) {
        return text
          .replace(/\\n/g, "<br>")   // handle newlines
          .replace(/\u00b2/g, "&sup2;"); // handle m²
      }

      async function startSession() {
        try {
          const res = await fetch("/new-session");
          const data = await res.json();
          sessionId = data.session_id;
          addMessage(data.welcome_message, "bot");
          sendBtn.disabled = false;
          inputEl.focus();
        } catch (e) {
          addMessage("Failed to start session.", "bot");
        }
      }

      async function sendMessage(message) {
        if (!sessionId) {
          addMessage("No session ID, please refresh.", "bot");
          return;
        }
        if (isWaitingForResponse) return;

        addMessage(message, "user");
        inputEl.value = "";
        sendBtn.disabled = true;
        isWaitingForResponse = true;

        // Create a new bot message div for the streaming response
        currentBotMessage = addMessage("", "bot");

        // Decide endpoint based on model selected
        const endpoint =
          selectedModel === "ollama" ? "/chat-stream-local" : "/chat-stream";

        const url = new URL(endpoint, window.location.origin);
        url.searchParams.append("message", message);
        url.searchParams.append("session_id", sessionId);

        try {
          const response = await fetch(url, { method: "GET" });
          const reader = response.body.getReader();
          const decoder = new TextDecoder("utf-8");

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value, { stream: true });

            const lines = chunk
              .split("\n")
              .filter((l) => l.startsWith("data: "));

            for (const line of lines) {
              let data = line.replace("data: ", "").trim();

              if (data === "[END]") {
                isWaitingForResponse = false;
                sendBtn.disabled = false;
                inputEl.focus();
                currentBotMessage = null;
              } else if (data.startsWith("[ERROR]")) {
                if (currentBotMessage) {
                  currentBotMessage.textContent = "Error: " + data.substring(7);
                } else {
                  addMessage("Error: " + data.substring(7), "bot");
                }
                isWaitingForResponse = false;
                sendBtn.disabled = false;
                inputEl.focus();
                currentBotMessage = null;
              } else {
                // Decode the JSON-escaped data back to original form
                try {
                  const decodedData = JSON.parse(`"${data}"`);
                  // Append decoded data to the current streaming message
                  if (currentBotMessage) {
                    appendToMessage(currentBotMessage, decodedData);
                  }
                } catch (e) {
                  // Fallback: if JSON parsing fails, use raw data
                  if (currentBotMessage) {
                    appendToMessage(currentBotMessage, data);
                  }
                }
              }
            }
          }
        } catch (e) {
          if (currentBotMessage) {
            currentBotMessage.textContent = "Error communicating with server.";
          } else {
            addMessage("Error communicating with server.", "bot");
          }
          isWaitingForResponse = false;
          sendBtn.disabled = false;
          inputEl.focus();
          currentBotMessage = null;
        }
      }

      sendBtn.addEventListener("click", () => {
        const msg = inputEl.value.trim();
        if (msg) sendMessage(msg);
      });

      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !sendBtn.disabled) {
          e.preventDefault();
          sendBtn.click();
        }
      });

      startSession();
    </script>
  </body>
</html>